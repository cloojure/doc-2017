<!DOCTYPE html>
<html><head><meta charset="UTF-8"><link href="css/default.css" rel="stylesheet" type="text/css"><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>tupelo.datomic documentation</title></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html">Tupelo 0.1.53 API documentation</a></h1></div><div class="sidebar" id="namespaces"><h3><a href="index.html"><span class="inner">Namespaces</span></a></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>tupelo</span></div></div></li><li class="depth-2 branch"><a href="tupelo.base64.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>base64</span></div></a></li><li class="depth-2 branch"><a href="tupelo.base64url.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>base64url</span></div></a></li><li class="depth-2 branch"><a href="tupelo.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2 branch"><a href="tupelo.csv.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>csv</span></div></a></li><li class="depth-2 branch current"><a href="tupelo.datomic.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>datomic</span></div></a></li><li class="depth-2 branch"><a href="tupelo.misc.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>misc</span></div></a></li><li class="depth-2 branch"><a href="tupelo.parse.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>parse</span></div></a></li><li class="depth-2 branch"><a href="tupelo.schema.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>schema</span></div></a></li><li class="depth-2 branch"><a href="tupelo.types.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>types</span></div></a></li><li class="depth-2"><a href="tupelo.y64.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>y64</span></div></a></li><li class="depth-1"><a href="user.html"><div class="inner"><span class="tree" style="top: -331px;"><span class="top" style="height: 340px;"></span><span class="bottom"></span></span><span>user</span></div></a></li></ul></div><div class="sidebar" id="vars"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="tupelo.datomic.html#var-datom-map"><div class="inner"><span>datom-map</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-datoms"><div class="inner"><span>datoms</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-eid-.3Eident"><div class="inner"><span>eid-&gt;ident</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-eids"><div class="inner"><span>eids</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-entity-map"><div class="inner"><span>entity-map</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-is-transaction.3F"><div class="inner"><span>is-transaction?</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-new-attribute"><div class="inner"><span>new-attribute</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-new-entity"><div class="inner"><span>new-entity</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-new-enum"><div class="inner"><span>new-enum</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-new-partition"><div class="inner"><span>new-partition</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-partition-eids"><div class="inner"><span>partition-eids</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-partition-name"><div class="inner"><span>partition-name</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-query"><div class="inner"><span>query</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-query-attr"><div class="inner"><span>query-attr</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-query-entity"><div class="inner"><span>query-entity</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-query-pull"><div class="inner"><span>query-pull</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-query-value"><div class="inner"><span>query-value</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-retract-entity"><div class="inner"><span>retract-entity</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-retract-value"><div class="inner"><span>retract-value</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-special-attrvals"><div class="inner"><span>special-attrvals</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-t-query"><div class="inner"><span>t-query</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-transact"><div class="inner"><span>transact</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-transactions"><div class="inner"><span>transactions</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-tx-datoms"><div class="inner"><span>tx-datoms</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-txid"><div class="inner"><span>txid</span></div></a></li><li class="depth-1"><a href="tupelo.datomic.html#var-update"><div class="inner"><span>update</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h2 class="anchor" id="top">tupelo.datomic</h2><div class="doc"><pre class="plaintext"></pre></div><div class="public anchor" id="var-datom-map"><h3>datom-map</h3><div class="usage"><code>(datom-map datom)</code></div><div class="doc"><pre class="plaintext">Inputs: [datom :- s/Any]
Returns: ts/DatomMap

Returns a plain Clojure map of an datom&apos;s attribute-value pairs.
 A datom map is structured as:

    { :e        entity id (eid)
      :a        attribute eid
      :v        value
      :tx       transaction eid
      :added    true/false (assertion/retraction) }
 </pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L411">view source</a></div></div><div class="public anchor" id="var-datoms"><h3>datoms</h3><div class="usage"><code>(datoms db index &amp; components)</code></div><div class="doc"><pre class="plaintext">Inputs: [db :- s/Any index :- s/Keyword &amp; components]
Returns: [ts/DatomMap]

Returns a lazy sequence of Clojure maps of an datom&apos;s attribute-value pairs.
 A datom map is structured as:

    { :e        entity id (eid)
      :a        attribute eid
      :v        value
      :tx       transaction eid
      :added    true/false (assertion/retraction) }

 Like (datomic.api/datoms ...), but returns a seq of plain Clojure maps.  </pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L430">view source</a></div></div><div class="public anchor" id="var-eid-.3Eident"><h3>eid-&gt;ident</h3><div class="usage"><code>(eid-&gt;ident db-val eid-val)</code></div><div class="doc"><pre class="plaintext">Inputs: [db-val :- s/Any eid-val :- ts/Eid]
Returns: s/Keyword

Returns the keyword ident value given an EID value</pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L399">view source</a></div></div><div class="public anchor" id="var-eids"><h3>eids</h3><div class="usage"><code>(eids tx-result)</code></div><div class="doc"><pre class="plaintext">Inputs: [tx-result :- ts/TxResult]
Returns: [ts/Eid]

Returns a collection of the EIDs created in a transaction.</pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L515">view source</a></div></div><div class="public anchor" id="var-entity-map"><h3>entity-map</h3><div class="usage"><code>(entity-map db-val entity-spec)</code></div><div class="doc"><pre class="plaintext">Inputs: [db-val :- datomic.db.Db entity-spec :- ts/EntitySpec]
Returns: ts/KeyMap

Returns a map of an entity&apos;s attribute-value pairs. A simpler, eager version of datomic/entity.</pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L392">view source</a></div></div><div class="public anchor" id="var-is-transaction.3F"><h3>is-transaction?</h3><div class="usage"><code>(is-transaction? db-val entity-spec)</code></div><div class="doc"><pre class="plaintext">Inputs: [db-val :- s/Any entity-spec :- ts/EntitySpec]
Returns: s/Bool

Returns true if an entity is a transaction (i.e. it is in the :db.part/tx partition)</pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L497">view source</a></div></div><div class="public anchor" id="var-new-attribute"><h3>new-attribute</h3><div class="usage"><code>(new-attribute ident value-type &amp; options)</code></div><div class="doc"><pre class="plaintext">Inputs: [ident :- s/Keyword value-type :- s/Any &amp; options]
Returns: ts/KeyMap

Returns the tx-data to create a new attribute in the DB.  Usage:

  (td/transact *conn*
    (attribute ident value-type &amp; options)
  )

 The first 2 params are required. Other params are optional and will use normal Datomic default
 values (false or nil) if omitted. An attribute is assumed to be :db.cardinality/one unless
 otherwise specified.  Optional values are:

    :db.unique/value
    :db.unique/identity
    :db.cardinality/one     &lt;- assumed by default
    :db.cardinality/many
    :db/index
    :db/fulltext
    :db/isComponent
    :db/noHistory
    :db/doc                 &lt;- *** currently unimplemented ***
</pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L100">view source</a></div></div><div class="public anchor" id="var-new-entity"><h3>new-entity</h3><div class="usage"><code>(new-entity attr-val-map)</code><code>(new-entity -partition attr-val-map)</code></div><div class="doc"><pre class="plaintext">Inputs: ([attr-val-map :- ts/KeyMap] [-partition :- s/Keyword attr-val-map :- ts/KeyMap])
Returns: ts/KeyMap

Returns the tx-data to create a new entity in the DB. Usage:

  (td/transact *conn*
    (new-entity attr-val-map)             ; default partition -&gt; :db.part/user
    (new-entity partition attr-val-map)   ; user-specified partition
  )

 where attr-val-map is a Clojure map containing attribute-value pairs to be added to the new
 entity.</pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L154">view source</a></div></div><div class="public anchor" id="var-new-enum"><h3>new-enum</h3><div class="usage"><code>(new-enum ident)</code></div><div class="doc"><pre class="plaintext">Inputs: [ident :- s/Keyword]
Returns: ts/KeyMap

Returns the tx-data to create a new enumeration entity in the DB. Usage:

  (td/transact *conn*
    (new-enum ident)
  )

where ident is the (keyword) name for the new enumeration entity.  </pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L171">view source</a></div></div><div class="public anchor" id="var-new-partition"><h3>new-partition</h3><div class="usage"><code>(new-partition ident)</code></div><div class="doc"><pre class="plaintext">Inputs: [ident :- s/Keyword]
Returns: ts/KeyMap

Returns the tx-data to create a new partition in the DB. Usage:

  (td/transact *conn*
    (partition ident)
  )
</pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L86">view source</a></div></div><div class="public anchor" id="var-partition-eids"><h3>partition-eids</h3><div class="usage"><code>(partition-eids db-val part-kw)</code></div><div class="doc"><pre class="plaintext">Inputs: [db-val :- datomic.db.Db part-kw :- s/Keyword]
Returns: [ts/Eid]

Returns a lazy sequence of all the EIDs in a partition.</pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L472">view source</a></div></div><div class="public anchor" id="var-partition-name"><h3>partition-name</h3><div class="usage"><code>(partition-name db-val entity-spec)</code></div><div class="doc"><pre class="plaintext">Inputs: [db-val :- datomic.db.Db entity-spec :- ts/EntitySpec]
Returns: s/Keyword

Returns the partition name (the :db/ident value) for an Entity</pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L465">view source</a></div></div><div class="public anchor" id="var-query"><h3>query</h3><h4 class="type">macro</h4><div class="usage"><code>(query &amp; args)</code></div><div class="doc"><pre class="plaintext">Returns query results as a set of tuples (i.e. a TupleSet, or #{ [s/Any] } in Prismatic Schema),
 where each tuple is unique. Usage:

  (td/query   :let    [$        (d/db *conn*)     ; assign multiple variables just like
                       ?name    &quot;Caribbean&quot;]    ;   in Clojure &apos;let&apos; special form
              :find   [?e ?name]
              :where  [ [?e :person/name ?name]
                        [?e :location ?loc] ] )

Unlike datomic.api/q, the query form does not need to be wrapped in a map literal nor is any
quoting required. Most importantly, the :in keyword has been replaced with the :let keyword, and
the syntax has been copied from the Clojure let special form so that both the query variables (the
variables $ and ?name in this case) are more closely aligned with their actual values. Also, the
implicit DB $ must be explicitly tied to its data source in all cases (as shown above).  </pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L277">view source</a></div></div><div class="public anchor" id="var-query-attr"><h3>query-attr</h3><h4 class="type">macro</h4><div class="usage"><code>(query-attr &amp; args)</code></div><div class="doc"><pre class="plaintext">Returns a Set of unique attribute values (i.e. #{s/Any}). Any duplicate values will be
discarded. Usage:

 (td/query-attr :let    [$        (d/db *conn*)       ; assign multiple variables just like
                        ?name    &quot;James Bond&quot;]     ;   in Clojure &apos;let&apos; special form
                :find   [?e]
                :where  [ [?e :person/name ?name] ] )
</pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L298">view source</a></div></div><div class="public anchor" id="var-query-entity"><h3>query-entity</h3><h4 class="type">macro</h4><div class="usage"><code>(query-entity &amp; args)</code></div><div class="doc"><pre class="plaintext">A query that returns a Tuple for a single entity. Usage:

 (td/query-entity :let    [$ (d/db *conn*)]
                  :find   [?eid ?name]  ; &lt;- output tuple shape
                  :where  [ [?eid :person/name ?name      ]
                            [?eid :location    &quot;Caribbean&quot;] ] )

It is an error if more than one matching entity is found.
</pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L316">view source</a></div></div><div class="public anchor" id="var-query-pull"><h3>query-pull</h3><h4 class="type">macro</h4><div class="usage"><code>(query-pull &amp; args)</code></div><div class="doc"><pre class="plaintext">Returns a TupleList [Tuple] of query results, where items may be duplicated. Intended only for
use with the Datomic Pull API. Usage:

  (td/query-pull  :let    [$ (d/db *conn*) ]
                  :find   [ (pull ?eid [:location]) ]
                  :where  [ [?eid :location] ] )

It is an error if the :find clause does not contain a Datomic Pull API request.  </pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L356">view source</a></div></div><div class="public anchor" id="var-query-value"><h3>query-value</h3><h4 class="type">macro</h4><div class="usage"><code>(query-value &amp; args)</code></div><div class="doc"><pre class="plaintext">A query that returns a single value.  Usage:

 (td/query-value :let    [$      (d/db *conn*)
                          ?name  &quot;James Bond&quot;]
                 :find   [?eid]
                 :where  [ [?eid :person/name ?name] ] )

It is an error if more than one value is found.</pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L333">view source</a></div></div><div class="public anchor" id="var-retract-entity"><h3>retract-entity</h3><div class="usage"><code>(retract-entity entity-spec)</code></div><div class="doc"><pre class="plaintext">Inputs: [entity-spec :- ts/EntitySpec]
Returns: ts/Vec2

Returns the tx-data to retract all attribute-value pairs for an entity, as well as all references
 to the entity by other entities. Usage:

  (td/transact *conn*
    (retract-entity entity-spec)
  )

If the retracted entity refers to any other entity through an attribute with :db/isComponent=true,
the referenced entity will be recursively retracted as well.</pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L215">view source</a></div></div><div class="public anchor" id="var-retract-value"><h3>retract-value</h3><div class="usage"><code>(retract-value entity-spec attribute value)</code></div><div class="doc"><pre class="plaintext">Inputs: [entity-spec :- ts/EntitySpec attribute :- s/Keyword value :- s/Any]
Returns: ts/Vec4

Returns the tx-data to retract an attribute-value pair for an entity. Only a single
 attribute-value pair can be retracted for each call to retract-value.  Usage:

  (td/transact *conn*
    (retract-value entity-spec attribute value)
  )

 where the attribute-value pair must exist for the entity or the retraction will fail.  </pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L201">view source</a></div></div><div class="public anchor" id="var-special-attrvals"><h3>special-attrvals</h3><div class="usage"></div><div class="doc"><pre class="plaintext">A map that defines the set of permissible values for use in attribute definition.

User-defined attributes are special entities in Datomic. They are stored in the :db.part/db
partition, and are defined by special attributes that are built-in to Datomic (this is analgous to
the special forms that are built-in to Clojure). The root attributes are named by the following
keywords (all in the &apos;db&apos; namespace):

  :db/id
  :db/ident
  :db/valueType
  :db/cardinality
  :db/unique
  :db/doc
  :db/index
  :db/fulltext
  :db/isComponent
  :db/noHistory

For each of these special attributes, this map defines the permissible values used for specifying
user-defined attributes. Most special attributes are defined by a set of permissible keyword
values. Permissible values for other special attributes are defined by a predicate function.  </pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L43">view source</a></div></div><div class="public anchor" id="var-t-query"><h3>t-query</h3><div class="usage"><code>(t-query)</code></div><div class="doc"><pre class="plaintext">Test the query macro, returns true on success.
</pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L372">view source</a></div></div><div class="public anchor" id="var-transact"><h3>transact</h3><div class="usage"><code>(transact conn &amp; tx-specs)</code></div><div class="doc"><pre class="plaintext">Inputs: [conn &amp; tx-specs]
Returns: s/Any

Like (datomic.api/transact ...) but does not require wrapping everything in a Clojure vector. Usage:

  (td/transact *conn*
    (td/new-entity attr-val-map)                 ; default partition -&gt; :db.part/user
    (td/update entity-spec-1 attr-val-map-1)
    (td/update entity-spec-2 attr-val-map-2))
 </pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L229">view source</a></div></div><div class="public anchor" id="var-transactions"><h3>transactions</h3><div class="usage"><code>(transactions db-val)</code></div><div class="doc"><pre class="plaintext">Inputs: [db-val :- s/Any]
Returns: [ts/KeyMap]

Returns a lazy sequence of entity-maps for all DB transactions</pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L504">view source</a></div></div><div class="public anchor" id="var-tx-datoms"><h3>tx-datoms</h3><div class="usage"><code>(tx-datoms db-val tx-result)</code></div><div class="doc"><pre class="plaintext">Inputs: [db-val :- s/Any tx-result :- ts/TxResult]
Returns: s/Any

Returns a vector of datom-maps from a TxResult</pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L448">view source</a></div></div><div class="public anchor" id="var-txid"><h3>txid</h3><div class="usage"><code>(txid tx-result)</code></div><div class="doc"><pre class="plaintext">Inputs: [tx-result :- ts/TxResult]
Returns: ts/Eid

Returns the EID of a transaction</pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L520">view source</a></div></div><div class="public anchor" id="var-update"><h3>update</h3><div class="usage"><code>(update entity-spec attr-val-map)</code></div><div class="doc"><pre class="plaintext">Inputs: [entity-spec :- ts/EntitySpec attr-val-map :- ts/KeyMap]
Returns: ts/KeyMap

Returns the tx-data to update an existing entity  Usage:

  (td/transact *conn*
    (update entity-spec attr-val-map)
  )

 where attr-val-map is a Clojure map containing attribute-value pairs to be added to the new
 entity.  For attributes with :db.cardinality/one, Datomic will (automatically) retract the
 previous value prior to the insertion of the new value. For attributes with :db.cardinality/many,
 the new value will be accumulated into the current set of values.</pre></div><div class="src-link"><a href="http://github.com/cloojure/tupelo/blob/master/src/tupelo/datomic.clj#L186">view source</a></div></div></div></body></html>